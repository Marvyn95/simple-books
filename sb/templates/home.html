<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inputs Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }
    .main-content {
      flex: 1 0 auto;
      overflow-y: auto;
      padding-top: 110px; /* Adjusted for fixed navbar and tabs */
      padding-bottom: 60px; /* Adjusted for fixed footer */
    }
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      background: white;
    }
    .tabs {
      position: fixed;
      top: 70px; /* Below navbar */
      width: 100%;
      background: white;
      z-index: 999;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 1000;
      background: white;
    }
    .card-body {
      padding: 0.75rem 1rem; /* Thinner cards */
    }
    .card-body .fs-5 {
      font-size: 1.1rem !important; /* Adjusted font for source */
    }
    .card-body .small {
      font-size: 0.85rem !important; /* Adjusted font for details */
    }
    .card-body .btn-sm {
      font-size: 0.8rem; /* Adjusted button font */
      padding: 0.2rem 0.5rem;
    }
  </style>
</head>

<body class="bg-light">
<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm px-3 pb-0 d-flex justify-content-between align-items-center" style="min-height: 70px;">
  <p class="fs-2 m-0">
    <span class="fw-bold" style="color: black;">Simple</span><span class="fst-italic fw-bold" style="color: rgb(3, 148, 3);">Books</span>
  </p>

  <!-- Flash messages (centered vertically and horizontally) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="position-absolute top-50 start-50 translate-middle" style="z-index: 1050; min-width: 300px; max-width: 500px;">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show d-flex justify-content-between align-items-center mb-0 px-3 py-2" role="alert">
            <span class="me-3">{{ message }}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex align-items-center">
    <span class="fw-bold me-3" style="white-space: nowrap;">{{ org['org_name'] }}</span>

    {% if user['role'] == "Owner" %}
    <!-- Location Dropdown -->
    <div class="dropdown me-3">
      <a class="btn d-flex align-items-center dropdown-toggle-custom-width" href="#" role="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" style="white-space: nowrap;">
        <span id="selected-location" class="text-truncate">{{ selected_location }}</span>
        <i class="bi bi-chevron-down ms-1"></i>
      </a>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="overflow-x: auto;">
        {% for location in org['locations'] %}
        <li>
          <form action="{{ url_for('home') }}" method="POST">
            <input type="hidden" name="selected_location" value="{{ location }}">
            <button type="submit" class="dropdown-item location-dropdown-item w-100 text-start">{{ location }}</button>
          </form>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <div class="dropdown me-3">
      <a class="btn d-flex align-items-center dropdown-toggle-custom-width" href="#" role="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" style="white-space: nowrap;">
        <span id="selected-location" class="text-truncate">{{ user['locations'][0] }}</span>
      </a>
    </div>
    {% endif %}

    <!-- User Dropdown -->
    <div class="dropdown" style="border-left: 2px solid black; color: rgb(3, 148, 3); cursor: pointer;">
      <div class="d-flex align-items-center ps-3 mx-2 dropdown-toggle-custom-width" role="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" style="white-space: nowrap;">
        <span class="fw-bold">{{ session['username'] }}</span>
      </div>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" style="min-width: unset;">
        <li>
          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}" onclick="localStorage.removeItem('lastActiveTabId'); localStorage.removeItem('lastActiveSubTabId');">Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Tabs -->
<div class="tabs fw-semibold mt-2">
  <div class="d-flex justify-content-center">
    <ul class="nav nav-tabs flex-nowrap" id="myTab" role="tablist" style="white-space: nowrap;">
      <li class="nav-item" role="presentation">
        <button class="nav-link active px-md-3 py-md-2 px-2 py-1" id="inputs-tab" data-bs-toggle="tab" data-bs-target="#inputs" type="button" role="tab">
          Inputs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link px-md-3 py-md-2 px-2 py-1" id="figures-tab" data-bs-toggle="tab" data-bs-target="#figures" type="button" role="tab">
          Daily Figures
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link px-md-3 py-md-2 px-2 py-1" id="debts-tab" data-bs-toggle="tab" data-bs-target="#debts" type="button" role="tab">
          Debts
        </button>
      </li>
      {% if user.role == 'Owner' %}
      <li class="nav-item" role="presentation">
        <button class="nav-link px-md-3 py-md-2 px-2 py-1" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
          Summaries
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link px-md-3 py-md-2 px-2 py-1" id="people-tab" data-bs-toggle="tab" data-bs-target="#people" type="button" role="tab">
          People
        </button>
      </li>
      {% endif %}
    </ul>
  </div>
</div>


<!-- Main Content -->
<main class="main-content">
  <div class="container">
    <div class="tab-content mt-3" id="myTabContent">
      <!-- Inputs Tab -->
      <div class="tab-pane fade show active" id="inputs" role="tabpanel">
        <div class="container py-4">
          <div class="row g-4 justify-content-center">
            <!-- Record Sales -->
            <div class="col-md-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4 class="card-title text-primary fs-4 mb-0">Sales</h4>
                    {% if user.role == 'Owner' %}
                      <div>
                        <button class="btn btn-outline-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#addSaleCategoryModal">
                          âž•
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#manageSalesCategoriesModal">
                          ðŸ› 
                        </button>
                      </div>
                    {% endif %}
                  </div>
                  <p class="card-text text-muted fs-6">Log and keep track of today's sales</p>
                  {% for source in org_income_categories %}
                    <div class="mt-3">
                      <button class="btn btn-outline-success btn-md w-100 text-start" data-bs-toggle="modal" data-bs-target="#incomeModal{{ loop.index }}">
                        âž• {{ source }}
                      </button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <!-- Record Expenses -->
            <div class="col-md-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4 class="card-title text-primary fs-4 mb-0">Expenses</h4>
                    {% if user.role == 'Owner' %}
                      <div>
                        <button class="btn btn-outline-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#addExpenseCategoryModal">
                          âž•
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#manageExpenseCategoriesModal">
                          ðŸ› 
                        </button>
                      </div>
                    {% endif %}
                  </div>
                  <p class="card-text text-muted fs-6">Log and keep track of today's expenses</p>
                  {% for source in org_expense_categories %}
                    <div class="mt-3">
                      <button class="btn btn-outline-danger btn-md w-100 text-start" data-bs-toggle="modal" data-bs-target="#expenseModal{{ loop.index }}">
                        âž– {{ source }}
                      </button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily Figures Tab -->
      <div class="tab-pane fade" id="figures" role="tabpanel">
        <div class="px-2">
          <!-- Tabs: Incomes and Expenses -->
          <ul class="nav nav-underline small fw-bold d-flex justify-content-center mb-2" role="tablist" id="figuresSubTabs">
            <li class="nav-item mx-2" role="presentation">
              <button class="nav-link active text-primary" id="daily-incomes-tab" data-bs-toggle="pill" data-bs-target="#daily-incomes" type="button" role="tab" aria-controls="daily-incomes" aria-selected="true">
                Incomes
              </button>
            </li>
            <li class="nav-item mx-2" role="presentation">
              <button class="nav-link text-danger" id="daily-expenses-tab" data-bs-toggle="pill" data-bs-target="#daily-expenses" type="button" role="tab" aria-controls="daily-expenses" aria-selected="false">
                Expenses
              </button>
            </li>
          </ul>
          <!-- Tab Content: Incomes & Expenses -->
          <div class="tab-content">
            <!-- Incomes Section -->
            <div class="tab-pane fade show active" id="daily-incomes" role="tabpanel" aria-labelledby="daily-incomes-tab">
              <div class="container d-flex justify-content-center">
                <div class="mt-2" style="max-height: calc(100vh - 250px); overflow-y: auto; max-width: 540px; width: 100%;">
                  {% for sale in org_sales %}
                    <!-- Income Entry Card -->
                    <div class="card border-primary mb-2 shadow-sm">
                      <div class="card-body py-2 px-3">
                        <!-- Top Row: Source and Amount -->
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <div class="text-muted small text-primary fs-5"><strong>{{ sale.income_source }}</strong></div>
                          <div class="text-primary fw-bold">
                            {{ "{:,.0f}".format(sale.amount) }}/=
                          </div>
                        </div>
                        <!-- Divider -->
                        <hr class="my-1 border-primary opacity-25">
                        <!-- Info Section -->
                        <div class="row small text-muted mb-1">
                          <div class="col-md-4 col-sm-12 mb-1"><strong>Date:</strong> {{ sale.date }}</div>
                          <div class="col-md-4 col-sm-12 mb-1"><strong>Sales Person:</strong> {{ sale.logger_name }}</div>
                          <div class="col-md-4 col-sm-12"><strong>Client:</strong> {{ sale.client_name }}</div>
                        </div>
                        <!-- Action Row with Comment -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-1 mt-2">
                          <div class="text-muted small fst-italic">
                            <i class="bi bi-chat-left-text me-1"></i> {{ sale.comments }}
                          </div>
                          {% if user._id == sale.logger_id or user.role == 'owner' %}
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editIncomeModal{{ sale._id }}">
                              Edit
                            </button>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    <!-- Modal for Editing Income -->
                    <div class="modal fade" id="editIncomeModal{{ sale._id }}" tabindex="-1" aria-labelledby="editIncomeModal{{ sale._id }}Label" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-primary">
                          <form method="post" action="{{ url_for('update_sale') }}">
                            <div class="modal-header bg-primary text-white">
                              <h6 class="modal-title" id="editIncomeModal{{ sale._id }}Label">Edit Income Entry</h6>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <input type="hidden" name="sale_id" value="{{ sale._id }}">
                              <div class="mb-2">
                                <label class="form-label small">Income Source</label>
                                <select class="form-select form-select-sm" name="source">
                                  {% for category in org.income_categories %}
                                    <option value="{{ category.category_name }}" {% if sale.income_source == category.category_name %}selected{% endif %}>
                                      {{ category.category_name }}
                                    </option>
                                  {% endfor %}
                                </select>
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Amount</label>
                                <input type="number" min="0" step="100" class="form-control form-control-sm" name="amount" value="{{ sale.amount }}">
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Client</label>
                                <input type="text" class="form-control form-control-sm" name="client" value="{{ sale.client_name }}">
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Comments</label>
                                <textarea class="form-control form-control-sm" name="comments" rows="2">{{ sale.comments }}</textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <!-- Expenses Section -->
            <div class="tab-pane fade" id="daily-expenses" role="tabpanel" aria-labelledby="daily-expenses-tab">
              <div class="container d-flex justify-content-center">
                <div class="mt-2" style="max-height: calc(100vh - 250px); overflow-y: auto; max-width: 540px; width: 100%;">
                  {% for expense in org_expenses %}
                    <!-- Expense Entry Card -->
                    <div class="card border-danger mb-2 shadow-sm">
                      <div class="card-body py-2 px-3">
                        <!-- Top Row: Expense Category and Amount -->
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <div class="text-muted small text-danger fs-5"><strong>{{ expense.expense_source }}</strong></div>
                          <div class="text-danger fw-bold">
                            {{ "{:,.0f}".format(expense.amount) }}/=
                          </div>
                        </div>
                        <!-- Divider -->
                        <hr class="my-1 border-danger opacity-25">
                        <!-- Info Section -->
                        <div class="row small text-muted mb-1">
                          <div class="col-md-4 col-sm-12 mb-1"><strong>Date:</strong> {{ expense.date }}</div>
                          <div class="col-md-4 col-sm-12 mb-1"><strong>Logged By:</strong> {{ expense.logger_name }}</div>
                          <div class="col-md-4 col-sm-12"><strong>Paid to:</strong> {{ expense.service_provider }}</div>
                        </div>
                        <!-- Action Row with Comment -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-1 mt-2">
                          <div class="text-muted small fst-italic">
                            <i class="bi bi-chat-left-text me-1"></i> {{ expense.comments }}
                          </div>
                          {% if user._id == expense.logger_id or user.role == 'owner' %}
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#editExpenseModal{{ expense._id }}">
                              Edit
                            </button>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    <!-- Modal for Editing Expense -->
                    <div class="modal fade" id="editExpenseModal{{ expense._id }}" tabindex="-1" aria-labelledby="editExpenseModal{{ expense._id }}Label" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-danger">
                          <form method="post" action="{{ url_for('update_expense') }}">
                            <div class="modal-header bg-danger text-white">
                              <h6 class="modal-title" id="editExpenseModal{{ expense._id }}Label">Edit Expense Entry</h6>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <input type="hidden" name="expense_id" value="{{ expense._id }}">
                              <div class="mb-2">
                                <label class="form-label small">Expense Category</label>
                                <select class="form-select form-select-sm" name="category">
                                  {% for category in org.expense_categories %}
                                    <option value="{{ category.category_name }}" {% if expense.expense_source == category.category_name %}selected{% endif %}>
                                      {{ category.category_name }}
                                    </option>
                                  {% endfor %}
                                </select>
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Amount</label>
                                <input type="number" min="0" step="100" class="form-control form-control-sm" name="amount" value="{{ expense.amount }}">
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Paid to:</label>
                                <input type="text" class="form-control form-control-sm" name="payee" value="{{ expense.service_provider }}">
                              </div>
                              <div class="mb-2">
                                <label class="form-label small">Comments</label>
                                <textarea class="form-control form-control-sm" name="comments" rows="2">{{ expense.comments }}</textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="submit" class="btn btn-danger btn-sm">Save Changes</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Debts Tab -->
      <div class="tab-pane fade" id="debts" role="tabpanel">
        <div class="px-2">
          <!-- Tab Navigation: Pending Incomes & Pending Expenses -->
          <ul class="nav nav-underline small fw-bold d-flex justify-content-center mb-2" role="tablist" id="debtsSubTabs">
            <li class="nav-item mx-2" role="presentation">
              <button class="nav-link active text-primary" id="pending-incomes-tab" data-bs-toggle="pill" data-bs-target="#pending-incomes" type="button" role="tab" aria-controls="pending-incomes" aria-selected="true">
                Pending Incomes
              </button>
            </li>
            <li class="nav-item mx-2" role="presentation">
              <button class="nav-link text-danger" id="pending-expenses-tab" data-bs-toggle="pill" data-bs-target="#pending-expenses" type="button" role="tab" aria-controls="pending-expenses" aria-selected="false">
                Pending Expenses
              </button>
            </li>
          </ul>
          <!-- Tab Content -->
          <div class="container d-flex justify-content-center">
            <div class="tab-content mt-2" style="max-height: calc(100vh - 250px); overflow-y: auto; max-width: 540px; width: 100%;">
              <!-- Pending Incomes Tab -->
              <div class="tab-pane fade show active" id="pending-incomes" role="tabpanel">
                {% for sale in org_pending_sales %}
                  <!-- Income Entry Card -->
                  <div class="card border-primary mb-2 shadow-sm">
                    <div class="card-body py-2 px-3">
                      <!-- Top Row: Source and Amount -->
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="text-muted small text-primary fs-5"><strong>{{ sale.income_source }}</strong></div>
                        <div class="text-primary fw-bold">
                          {{ "{:,.0f}".format(sale.amount) }}/=
                          <small class="text-muted fw-normal">({{ "{:,.0f}".format(sale.amount_left) }}/= left)</small>
                        </div>
                      </div>
                      <!-- Divider -->
                      <hr class="my-1 border-primary opacity-25">
                      <!-- Info Section -->
                      <div class="row small text-muted mb-1">
                        <div class="col-md-4 col-sm-12 mb-1"><strong>Date:</strong> {{ sale.date }}</div>
                        <div class="col-md-4 col-sm-12 mb-1"><strong>Sales Person:</strong> {{ sale.logger_name }}</div>
                        <div class="col-md-4 col-sm-12"><strong>Customer:</strong> {{ sale.client_name }}</div>
                      </div>
                      <!-- Action Row with Comment -->
                      <div class="d-flex justify-content-between align-items-center border-top pt-1 mt-2">
                        <div class="text-muted small fst-italic">
                          <i class="bi bi-chat-left-text me-1"></i> {{ sale.comments }}
                        </div>
                        <div>
                          <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#pendingIncomeEditModal{{ loop.index }}">
                            Edit
                          </button>
                          <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#pendingIncomeDetailModal{{ loop.index }}">
                            Payments
                          </button>
                          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#pendingIncomeModal{{ loop.index }}">
                            Clear
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Edit Pending Income Modal -->
                  <div class="modal fade" id="pendingIncomeEditModal{{ loop.index }}" tabindex="-1" aria-labelledby="editIncomeModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content border-primary">
                        <form method="POST" action="{{ url_for('update_sale') }}">
                          <div class="modal-header bg-primary text-white">
                            <h6 class="modal-title" id="editIncomeModalLabel{{ loop.index }}">Edit Income Entry</h6>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <input type="hidden" name="sale_id" value="{{ sale._id }}">
                            <div class="mb-2">
                              <label class="form-label small">Income Source</label>
                              <select class="form-select form-select-sm" name="source">
                                {% for category in org.income_categories %}
                                  <option value="{{ category.category_name }}" {% if sale.income_source == category.category_name %}selected{% endif %}>
                                    {{ category.category_name }}
                                  </option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Amount</label>
                              <input type="number" min="0" step="100" class="form-control form-control-sm" name="amount" value="{{ sale.amount }}">
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Client</label>
                              <input type="text" class="form-control form-control-sm" name="client" value="{{ sale.client_name }}">
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Comments</label>
                              <textarea class="form-control form-control-sm" name="comments" rows="2">{{ sale.comments }}</textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <!-- Income Payment History Modal -->
                  <div class="modal fade" id="pendingIncomeDetailModal{{ loop.index }}" tabindex="-1" aria-labelledby="pendingIncomeDetailModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-md modal-dialog-scrollable">
                      <div class="modal-content shadow-sm border-0">
                        <div class="modal-header bg-primary text-white">
                          <h6 class="modal-title mb-0" id="pendingIncomeDetailModalLabel{{ loop.index }}">Payment History</h6>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body px-4 py-3">
                          <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                              <thead class="table-light">
                                <tr class="small text-muted">
                                  <th>Amount (UGX)</th>
                                  <th>Date</th>
                                  <th>Recorded By</th>
                                </tr>
                              </thead>
                              <tbody class="small">
                                {% for payment in sale.payment_history %}
                                  <tr>
                                    <td class="fw-semibold text-primary">{{ payment.amount }}</td>
                                    <td>{{ payment.date }}</td>
                                    <td>{{ payment.logger_name }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div class="modal-footer py-2 px-4 border-top-0">
                          <button type="button" class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Back</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Clear Income Debt Modal -->
                  <div class="modal fade" id="pendingIncomeModal{{ loop.index }}" tabindex="-1" aria-labelledby="pendingIncomeModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
                      <div class="modal-content border-0 shadow-sm rounded-3">
                        <form method="POST" action="{{ url_for('clear_income_debt') }}">
                          <input type="hidden" name="sale_id" value="{{ sale._id }}">                
                          <div class="modal-header border-bottom-0 pb-2 pt-3 px-4">
                            <h6 class="modal-title text-primary fw-semibold" id="pendingIncomeModalLabel{{ loop.index }}">Clear Income Debt</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body px-4 pt-0 pb-3">
                            <div class="mb-3">
                              <label for="pendingIncomeAmount{{ loop.index }}" class="form-label fw-semibold small text-muted">
                                Amount to Clear <span class="text-primary">({{ sale.amount_left }}/= Left)</span>
                              </label>
                              <input type="number" min="0" step="100" name="amount" required class="form-control form-control-sm" id="pendingIncomeAmount{{ loop.index }}" placeholder="Enter amount">
                            </div>
                          </div>
                          <div class="modal-footer border-top-0 px-4 pt-1 pb-3">
                            <button type="button" class="btn btn-sm btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <!-- Pending Expenses Tab -->
              <div class="tab-pane fade" id="pending-expenses" role="tabpanel">
                {% for expense in org_pending_expenses %}
                  <!-- Expense Entry Card -->
                  <div class="card border-danger mb-2 shadow-sm">
                    <div class="card-body py-2 px-3">
                      <!-- Top Row: Expense Type and Amount -->
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="text-muted small text-danger fs-5"><strong>{{ expense.expense_source }}</strong></div>
                        <div class="text-danger fw-bold">
                          {{ "{:,.0f}".format(expense.amount) }}/=
                          <small class="text-muted fw-normal">({{ "{:,.0f}".format(expense.amount_left) }}/= left)</small>
                        </div>
                      </div>
                      <!-- Divider -->
                      <hr class="my-1 border-danger opacity-25">
                      <!-- Info Section -->
                      <div class="row small text-muted mb-1">
                        <div class="col-md-4 col-sm-12 mb-1"><strong>Date:</strong> {{ expense.date }}</div>
                        <div class="col-md-4 col-sm-12 mb-1"><strong>Filed By:</strong> {{ expense.logger_name }}</div>
                        <div class="col-md-4 col-sm-12"><strong>Recipient:</strong> {{ expense.service_provider }}</div>
                      </div>
                      <!-- Action Row with Comment -->
                      <div class="d-flex justify-content-between align-items-center border-top pt-1 mt-2">
                        <div class="text-muted small fst-italic">
                          <i class="bi bi-chat-left-text me-1"></i> {{ expense.comments }}
                        </div>
                        <div>
                          <button class="btn btn-sm btn-outline-danger me-1" data-bs-toggle="modal" data-bs-target="#pendingExpenseEditModal{{ loop.index }}">
                            Edit
                          </button>
                          <button class="btn btn-sm btn-outline-danger me-1" data-bs-toggle="modal" data-bs-target="#pendingExpenseDetailModal{{ loop.index }}">
                            Payments
                          </button>
                          <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#pendingExpenseModal{{ loop.index }}">
                            Clear
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Edit Expense Modal -->
                  <div class="modal fade" id="pendingExpenseEditModal{{ loop.index }}" tabindex="-1" aria-labelledby="editExpenseModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content border-danger">
                        <form method="POST" action="{{ url_for('update_expense') }}">
                          <div class="modal-header bg-danger text-white">
                            <h6 class="modal-title" id="editExpenseModalLabel{{ loop.index }}">Edit Expense Entry</h6>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <input type="hidden" name="expense_id" value="{{ expense._id }}">
                            <div class="mb-2">
                              <label class="form-label small">Expense Source</label>
                              <select class="form-select form-select-sm" name="category">
                                {% for category in org.expense_categories %}
                                  <option value="{{ category.category_name }}" {% if expense.expense_source == category.category_name %}selected{% endif %}>
                                    {{ category.category_name }}
                                  </option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Amount</label>
                              <input type="number" min="0" step="100" class="form-control form-control-sm" name="amount" value="{{ expense.amount }}">
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Recipient / Vendor</label>
                              <input type="text" class="form-control form-control-sm" name="payee" value="{{ expense.service_provider }}">
                            </div>
                            <div class="mb-2">
                              <label class="form-label small">Comments</label>
                              <textarea class="form-control form-control-sm" name="comments" rows="2">{{ expense.comments }}</textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="submit" class="btn btn-danger btn-sm">Save Changes</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  <!-- Expense Payment History Modal -->
                  <div class="modal fade" id="pendingExpenseDetailModal{{ loop.index }}" tabindex="-1" aria-labelledby="pendingExpenseDetailModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-md modal-dialog-scrollable">
                      <div class="modal-content shadow-sm border-0">
                        <div class="modal-header bg-danger text-white">
                          <h6 class="modal-title mb-0" id="pendingExpenseDetailModalLabel{{ loop.index }}">Payment History</h6>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body px-4 py-3">
                          <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                              <thead class="table-light">
                                <tr class="small text-muted">
                                  <th>Amount (UGX)</th>
                                  <th>Date</th>
                                  <th>Recorded By</th>
                                </tr>
                              </thead>
                              <tbody class="small">
                                {% for payment in expense.payment_history %}
                                  <tr>
                                    <td class="fw-semibold text-danger">{{ payment.amount }}</td>
                                    <td>{{ payment.date }}</td>
                                    <td>{{ payment.logger_name }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>
                        </div>
                        <div class="modal-footer py-2 px-4 border-top-0">
                          <button type="button" class="btn btn-outline-danger btn-sm" data-bs-dismiss="modal">Back</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Clear Expense Debt Modal -->
                  <div class="modal fade" id="pendingExpenseModal{{ loop.index }}" tabindex="-1" aria-labelledby="pendingExpenseModalLabel{{ loop.index }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
                      <div class="modal-content border-0 shadow-sm rounded-3">
                        <form method="POST" action="{{ url_for('clear_expense_debt') }}">
                          <input type="hidden" name="expense_id" value="{{ expense._id }}">                
                          <div class="modal-header border-bottom-0 pb-2 pt-3 px-4">
                            <h6 class="modal-title text-danger fw-semibold" id="pendingExpenseModalLabel{{ loop.index }}">Clear Expense Debt</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body px-4 pt-0 pb-3">
                            <div class="mb-3">
                              <label for="pendingExpenseAmount{{ loop.index }}" class="form-label fw-semibold small text-muted">
                                Amount to Clear <span class="text-danger">({{ expense.amount_left }}/= Left)</span>
                              </label>
                              <input type="number" min="0" step="100" name="amount" required class="form-control form-control-sm" id="pendingExpenseAmount{{ loop.index }}" placeholder="Enter amount">
                            </div>
                          </div>
                          <div class="modal-footer border-top-0 px-4 pt-1 pb-3">
                            <button type="button" class="btn btn-sm btn-light me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-sm btn-danger">Save</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Summaries Tab -->
      <div class="tab-pane fade" id="summary" role="tabpanel">
        <div class="d-flex flex-column p-3">
          <!-- Cards Container -->
          <div class="container mb-4" style="max-width: 960px;">
            <div class="row g-3 justify-content-center">
              <!-- Financial Summary -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-primary" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-primary fs-6">Financial Summary</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Total Income</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">{{ summary_info.total_income }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Total Expenses</dt>
                      <dd class="col-6 text-danger fw-bold text-truncate">{{ summary_info.total_expenses }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Net Profit</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">{{ summary_info.net_profit }}</dd>
                    </dl>
                  </div>
                </div>
              </div>
              <!-- Ratios & Averages -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-primary" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-primary fs-6">Ratios & Averages</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Profit Margin</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">{{ summary_info.profit_margin}}</dd>
                      <dt class="col-6 text-truncate text-black-50">Expense-to-Income Ratio</dt>
                      <dd class="col-6 text-danger fw-bold text-truncate">{{ summary_info.exp_to_inc_ratio }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Avg Daily Income</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">{{ summary_info.average_daily_income }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Avg Daily Expense</dt>
                      <dd class="col-6 text-danger fw-bold text-truncate">{{ summary_info.average_daily_expense }}</dd>
                    </dl>
                  </div>
                </div>
              </div>
              <!-- Sectors -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-primary" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-primary fs-6">Sectors</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Best Sector</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">{{ summary_info.best_sector }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Worst Sector</dt>
                      <dd class="col-6 text-danger fw-bold text-wrap">{{ summary_info.worst_sector }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Top 3 Sectors</dt>
                      <dd class="col-6 text-success fw-bold text-wrap">{{ summary_info.top_sectors }}</dd>
                      <dt class="col-6 text-truncate text-black-50">Most Active Sector</dt>
                      <dd class="col-6 text-success fw-bold text-wrap">{{ summary_info.most_active_sector }}</dd>
                    </dl>
                  </div>
                </div>
              </div>
              <!-- Clients -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-primary" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-primary fs-6">Clients</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Biggest Client</dt>
                      <dd class="col-6 fw-bold text-black text-truncate">
                        {{ summary_info.biggest_client.category if summary_info.biggest_client != 'N/A' else 'N/A' }}
                      </dd>
                      <dt class="col-6 text-truncate text-black-50">Top 3 Clients</dt>
                      <dd class="col-6 fw-bold text-black text-wrap">
                        {{ summary_info.top_3_clients if summary_info.top_3_clients != 'N/A' else 'N/A' }}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
              <!-- Expenses -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-danger" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-danger fs-6">Expenses</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Biggest Expense</dt>
                      <dd class="col-6 fw-bold text-danger text-truncate">
                        {{ summary_info.biggest_expense[0] if summary_info.biggest_expense != 'N/A' else 'N/A' }}
                      </dd>
                      <dt class="col-6 text-truncate text-black-50">Most Common Expense</dt>
                      <dd class="col-6 fw-bold text-danger text-truncate">
                        {{ summary_info.most_common_expense.category if summary_info.most_common_expense != 'N/A' else 'N/A' }}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
              <!-- Daily Metrics -->
              <div class="col-lg-4 col-md-6">
                <div class="card shadow-sm h-100 border-primary" style="padding: 0.6rem;">
                  <div class="card-body p-2">
                    <h5 class="card-title mb-2 text-primary fs-6">Daily Metrics</h5>
                    <dl class="row mb-0" style="font-size: 0.75rem;">
                      <dt class="col-6 text-truncate text-black-50">Most Profitable Day</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">
                        {{ summary_info.most_profitable_day[0] if summary_info.most_profitable_day != 'N/A' else 'N/A' }}
                      </dd>
                      <dt class="col-6 text-truncate text-black-50">Least Profitable Day</dt>
                      <dd class="col-6 fw-bold text-danger text-truncate">
                        {{ summary_info.least_profitable_day[0] if summary_info.least_profitable_day != 'N/A' else 'N/A' }}
                      </dd>
                      <dt class="col-6 text-truncate text-black-50">Most Active Day</dt>
                      <dd class="col-6 text-success fw-bold text-truncate">
                        {{ summary_info.most_active_day.day if summary_info.most_active_day != 'N/A' else 'N/A' }}
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- People Tab -->
      <div class="tab-pane fade" id="people" role="tabpanel">
        <div class="container-fluid py-3">
          <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
              <!-- Add Person Button -->
              <div class="mb-3">
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#personModal">
                  <i class="bi bi-person-plus me-1"></i> Add Employee
                </button>
              </div>
              <!-- People List -->
              <ul class="list-group shadow-sm rounded">
                {% for emp in org_employees %}
                  <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center py-2 px-3">
                    <!-- Employee Info -->
                    <div class="d-flex flex-column">
                      <strong class="text-capitalize mb-1">{{ emp.user_name }}</strong>
                      <small class="text-muted">{{ emp.role }}</small>
                      {% if emp.role == 'Employee' %}
                        <small class="text-muted">{{ emp.locations[0] }}</small>
                      {% endif %}
                    </div>
                    <!-- Actions -->
                    <div class="d-flex gap-2 mt-2 mt-md-0">
                      <i class="bi bi-pencil-square text-primary fs-6" role="button" title="Edit" data-bs-toggle="modal" data-bs-target="#editModal{{ emp.user_name | replace(' ', '') }}"></i>
                      {% if emp.role == 'Employee' %}
                        <i class="bi bi-trash text-danger fs-6" role="button" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteModal{{ emp.user_name | replace(' ', '') }}"></i>
                      {% endif %}
                      <i class="bi bi-shield-lock text-warning fs-6" role="button" title="Change Password" data-bs-toggle="modal" data-bs-target="#passwordModal{{ emp.user_name | replace(' ', '') }}"></i>
                    </div>
                  </li>
                  <!-- Edit Modal -->
                  <div class="modal fade" id="editModal{{ emp.user_name | replace(' ', '') }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <form method="POST" action="{{ url_for('edit_employee') }}" class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Employee</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <input type="hidden" name="emp_id" value="{{ emp._id }}">
                          <input type="hidden" name="username" value="{{ emp.user_name }}">
                          <div class="mb-2">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control form-control-sm" name="name" value="{{ emp.user_name }}">
                          </div>
                          {% if emp.role == 'Employee' %}
                            <div class="mb-2">
                              <label class="form-label">Location</label>
                              <select class="form-select form-select-sm" name="location" required>
                                {% for loc in org.locations %}
                                  <option value="{{ loc }}" {% if loc == emp.locations[0] %}selected{% endif %}>{{ loc }}</option>
                                {% endfor %}
                              </select>
                            </div>
                          {% else %}
                            <input type="hidden" name="location" value="{{ emp.locations[0] }}">
                          {% endif %}
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-primary">Save</button>
                        </div>
                      </form>
                    </div>
                  </div>
                  <!-- Delete Modal -->
                  <div class="modal fade" id="deleteModal{{ emp.user_name | replace(' ', '') }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <form action="{{ url_for('delete_emp') }}" method="POST" class="modal-content">
                        <div class="modal-header bg-danger text-white">
                          <h5 class="modal-title">Confirm Delete</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p>Delete <strong>{{ emp.user_name }}</strong>?</p>
                          <input type="hidden" name="emp_id" value="{{ emp._id }}">
                          <input type="hidden" name="emp_name" value="{{ emp.user_name }}">
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </div>
                      </form>
                    </div>
                  </div>
                  <!-- Password Modal -->
                  <div class="modal fade" id="passwordModal{{ emp.user_name | replace(' ', '') }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <form method="POST" action="{{ url_for('update_password') }}" class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Change Password â€“ {{ emp.user_name }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <input type="hidden" name="user_id" value="{{ emp._id }}">
                          <div class="mb-2">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control form-control-sm" name="new_password" required>
                          </div>
                          <div class="mb-2">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-control form-control-sm" name="confirm_password" required>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-warning">Update</button>
                        </div>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="bg-white text-center py-3 shadow-sm small text-muted">
  Â© {{ year }} SimpleBooks
</footer>

<!-- Add Income Category Modal -->
<div class="modal fade" id="addSaleCategoryModal" tabindex="-1" aria-labelledby="addSaleCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('add_income_category') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addSaleCategoryModalLabel">Add Income Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="incomeCategory" class="form-label">Income Category</label>
            <input type="text" class="form-control" id="incomeCategory" name="income_category" required>
          </div>
          <div class="mb-3">
            <label for="incomeDescription" class="form-label">Description (optional)</label>
            <textarea class="form-control" id="incomeDescription" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Add Expense Category Modal -->
<div class="modal fade" id="addExpenseCategoryModal" tabindex="-1" aria-labelledby="addExpenseCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('add_expense_category') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addExpenseCategoryModalLabel">Add Expense Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="expenseCategory" class="form-label">Expense Category</label>
            <input type="text" class="form-control" id="expenseCategory" name="expense_category" required>
          </div>
          <div class="mb-3">
            <label for="expenseDescription" class="form-label">Description (optional)</label>
            <textarea class="form-control" id="expenseDescription" name="description" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal for adding sale -->
{% for source in org_income_categories %}
<div class="modal fade" id="incomeModal{{ loop.index }}" tabindex="-1" aria-labelledby="incomeModalLabel{{ loop.index }}" aria-hidden="true">
  <div class="modal-dialog" style="max-width: 500px;">
    <form method="POST" action="{{ url_for('add_sale') }}">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title text-primary" id="incomeModalLabel{{ loop.index }}">Add Sale â€“ {{ source }}</h5>
          <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-2 px-3">
          <div class="mb-2">
            <label class="form-label small">Income Source</label>
            <input type="text" class="form-control form-control-sm" value="{{ source }}" readonly>
            <input type="hidden" name="income_source" value="{{ source }}">
          </div>
          <div class="mb-2">
            <label for="amount{{ loop.index }}" class="form-label small">Amount</label>
            <input type="number" min="0" step="100" class="form-control form-control-sm" id="amount{{ loop.index }}" name="amount" required>
          </div>
          <div class="mb-2">
            <label class="form-label small d-block">Type</label>
            <div class="d-flex gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="typeCash{{ loop.index }}" value="cash" checked>
                <label class="form-check-label small" for="typeCash{{ loop.index }}">Cash</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="typeDebt{{ loop.index }}" value="debt">
                <label class="form-check-label small" for="typeDebt{{ loop.index }}">Debt</label>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <label for="clientName{{ loop.index }}" class="form-label small">Client Name</label>
            <input type="text" class="form-control form-control-sm" id="clientName{{ loop.index }}" name="client_name" required>
          </div>
          <div class="mb-2">
            <label class="form-label small d-block">Destination of Funds</label>
            <div class="d-flex gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="destination" id="destCash{{ loop.index }}" value="cash register" checked>
                <label class="form-check-label small" for="destCash{{ loop.index }}">Cash Register</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="destination" id="destBank{{ loop.index }}" value="bank">
                <label class="form-check-label small" for="destBank{{ loop.index }}">Bank</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="destination" id="destMM{{ loop.index }}" value="mobile money">
                <label class="form-check-label small" for="destMM{{ loop.index }}">Mobile Money</label>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <label for="comments{{ loop.index }}" class="form-label small">Comments</label>
            <textarea class="form-control form-control-sm" id="comments{{ loop.index }}" name="comments" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="submit" class="btn btn-sm btn-success">Submit Income</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Modal for adding expense -->
{% for source in org_expense_categories %}
<div class="modal fade" id="expenseModal{{ loop.index }}" tabindex="-1" aria-labelledby="expenseModalLabel{{ loop.index }}" aria-hidden="true">
  <div class="modal-dialog" style="max-width: 500px;">
    <form method="POST" action="{{ url_for('add_expense') }}">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h5 class="modal-title text-danger" id="expenseModalLabel{{ loop.index }}">Add Expense â€“ {{ source }}</h5>
          <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body py-2 px-3">
          <div class="mb-2">
            <label class="form-label small">Expense Source</label>
            <input type="text" class="form-control form-control-sm" value="{{ source }}" readonly>
            <input type="hidden" name="expense_source" value="{{ source }}">
          </div>
          <div class="mb-2">
            <label for="amount{{ loop.index }}" class="form-label small">Amount</label>
            <input type="number" min="0" step="100" class="form-control form-control-sm" id="amount{{ loop.index }}" name="amount" required>
          </div>
          <div class="mb-2">
            <label class="form-label small d-block">Type</label>
            <div class="d-flex gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="typeCash{{ loop.index }}" value="cash" checked>
                <label class="form-check-label small" for="typeCash{{ loop.index }}">Cash</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="type" id="typeDebt{{ loop.index }}" value="debt">
                <label class="form-check-label small" for="typeDebt{{ loop.index }}">Debt</label>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <label for="recipient{{ loop.index }}" class="form-label small">Recipient / Vendor</label>
            <input type="text" class="form-control form-control-sm" id="recipient{{ loop.index }}" name="recipient" required>
          </div>
          <div class="mb-2">
            <label class="form-label small d-block">Payment Method</label>
            <div class="d-flex gap-3">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="payment_method" id="payCash{{ loop.index }}" value="cash" checked>
                <label class="form-check-label small" for="payCash{{ loop.index }}">Cash Register</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="payment_method" id="payBank{{ loop.index }}" value="bank">
                <label class="form-check-label small" for="payBank{{ loop.index }}">Bank</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="payment_method" id="payMM{{ loop.index }}" value="mobile money">
                <label class="form-check-label small" for="payMM{{ loop.index }}">Mobile Money</label>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <label for="comments{{ loop.index }}" class="form-label small">Comments</label>
            <textarea class="form-control form-control-sm" id="comments{{ loop.index }}" name="comments" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="submit" class="btn btn-sm btn-danger">Submit Expense</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Add People / Employee Modal -->
<div class="modal fade" id="personModal" tabindex="-1" aria-labelledby="personModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 rounded-4 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="personModalLabel">Register New Employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body px-4 py-3">
        <p class="text-muted text-center mb-3">Register your business employees</p>
        <form action="{{ url_for('register_emp') }}" method="POST">
          <!-- Username -->
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <!-- Password -->
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" name="password" required>
          </div>
          <!-- Location -->
          <div class="mb-3">
            <label for="location" class="form-label">Location</label>
            <select class="form-select" name="location" id="location" required>
              <option value="" disabled selected>-- Select Employee location --</option>
              {% for loc in org["locations"] %}
                <option value="{{ loc }}">{{ loc }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Submit -->
          <div class="d-grid">
            <button type="submit" class="btn btn-success">
              Register Employee
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Manage Sales Categories Modal -->
<div class="modal fade" id="manageSalesCategoriesModal" tabindex="-1" aria-labelledby="manageSalesLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="manageSalesLabel">Manage Sales Categories</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group">
          {% for cat in org_income_categories %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ cat }}
              <form action="{{ url_for('delete_sales_category') }}" method="POST" class="ms-2">
                <input type="hidden" name="category" value="{{ cat }}">
                <button type="submit" class="btn btn-sm btn-danger" {% if user.role != 'Owner' %}disabled{% endif %}>
                  Delete
                </button>
              </form>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Manage Expense Categories Modal -->
<div class="modal fade" id="manageExpenseCategoriesModal" tabindex="-1" aria-labelledby="manageExpenseLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="manageExpenseLabel">Manage Expense Categories</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group">
          {% for cat in org_expense_categories %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ cat }}
              <form action="{{ url_for('delete_expense_category') }}" method="POST" class="ms-2">
                <input type="hidden" name="category" value="{{ cat }}">
                <button type="submit" class="btn btn-sm btn-danger" {% if user.role != 'Owner' %}disabled{% endif %}>
                  Delete
                </button>
              </form>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle main tabs
    const mainTabButtons = document.querySelectorAll('#myTab button[data-bs-toggle="tab"]');
    const debtsSubTabButtons = document.querySelectorAll('#debtsSubTabs button[data-bs-toggle="pill"]');
    const figuresSubTabButtons = document.querySelectorAll('#figuresSubTabs button[data-bs-toggle="pill"]');

    // Load and show the last active main tab
    const lastMainTabId = localStorage.getItem("lastActiveTabId");
    if (lastMainTabId) {
      const lastMainTab = document.getElementById(lastMainTabId);
      if (lastMainTab) {
        new bootstrap.Tab(lastMainTab).show();
      }
    }

    // Load and show the last active sub-tab
    const lastSubTabId = localStorage.getItem("lastActiveSubTabId");
    if (lastSubTabId) {
      const lastSubTab = document.getElementById(lastSubTabId);
      if (lastSubTab) {
        new bootstrap.Tab(lastSubTab).show();
      }
    }

    // Save main tab ID when a main tab is shown
    mainTabButtons.forEach(btn => {
      btn.addEventListener("shown.bs.tab", function (event) {
        const activeMainTabId = event.target.id;
        localStorage.setItem("lastActiveTabId", activeMainTabId);
      });
    });

    // Save sub-tab ID when a sub-tab is shown
    debtsSubTabButtons.forEach(btn => {
      btn.addEventListener("shown.bs.tab", function (event) {
        const activeSubTabId = event.target.id;
        localStorage.setItem("lastActiveSubTabId", activeSubTabId);
      });
    });

    figuresSubTabButtons.forEach(btn => {
      btn.addEventListener("shown.bs.tab", function (event) {
        const activeSubTabId = event.target.id;
        localStorage.setItem("lastActiveSubTabId", activeSubTabId);
      });
    });
  });
</script>
</body>
</html>